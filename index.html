<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚¹ãƒãƒƒã‚·ãƒ¥ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;800&family=Orbitron:wght@700&display=swap" rel="stylesheet">

<style>
:root {
    --bg-color: #121212;
    --primary: #00ffff;
    --accent: #ff0055;
    --glass: rgba(255, 255, 255, 0.1);
}

body {
    margin: 0; background: var(--bg-color); color: #fff;
    font-family: 'M PLUS Rounded 1c', sans-serif;
    height: 100vh; overflow: hidden; touch-action: none;
    display: flex; justify-content: center; align-items: center;
}

.screen {
    position: absolute; width: 100%; height: 100%;
    display: none; flex-direction: column; align-items: center; justify-content: center;
    background: radial-gradient(circle, #222 0%, #000 100%); z-index: 1;
}
.screen.active { display: flex; z-index: 10; }

h1 { font-family: 'Orbitron', sans-serif; font-size: 3rem; text-shadow: 0 0 20px var(--primary); margin-bottom: 10px; line-height: 1; text-align: center; }
.desc { font-size: 0.9rem; color: #aaa; margin-bottom: 30px; text-align: center; }

/* ãƒœã‚¿ãƒ³ */
.btn {
    width: 280px; padding: 15px; margin: 10px;
    background: var(--glass); border: 2px solid var(--primary); color: var(--primary);
    font-family: 'Orbitron', sans-serif; font-size: 1.2rem; cursor: pointer;
    text-transform: uppercase; letter-spacing: 2px; transition: 0.2s;
    backdrop-filter: blur(5px);
}
.btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 20px var(--primary); }
.btn-accent { border-color: var(--accent); color: var(--accent); }
.btn-accent:hover { background: var(--accent); color: #000; box-shadow: 0 0 20px var(--accent); }

/* ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠ */
#game-wrapper {
    position: relative; width: 100%; height: 100%; max-width: 600px; max-height: 800px;
    background: #000; border: 2px solid #333; box-shadow: 0 0 50px rgba(0,0,0,0.8);
}
canvas { display: block; width: 100%; height: 100%; }

/* HUD */
.hud {
    position: absolute; top: 0; left: 0; width: 100%; padding: 10px;
    display: flex; justify-content: space-between; box-sizing: border-box;
    font-family: 'Orbitron'; font-size: 1.2rem; pointer-events: none;
    text-shadow: 0 2px 0 #000;
}

/* æ“ä½œã‚¬ã‚¤ãƒ‰ */
.controls-guide {
    position: absolute; bottom: 10px; width: 100%; text-align: center;
    font-size: 0.7rem; color: #666; pointer-events: none;
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal {
    position: absolute; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.8); z-index: 20;
    display: none; flex-direction: column; justify-content: center; align-items: center;
}
.modal h2 { font-family: 'Orbitron'; font-size: 3rem; margin-bottom: 20px; text-shadow: 0 0 20px #fff; }

/* ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯UI */
#qr-view { background: #fff; padding: 10px; border-radius: 5px; margin: 20px; }
#cam-view { width: 250px; border: 2px solid var(--primary); display: none; margin: 20px; }
.input-code { background: #333; border: 1px solid #555; color: #fff; padding: 10px; font-size: 1.2rem; text-align: center; margin: 10px; width: 200px; }

</style>
</head>
<body>

<!-- ã‚¿ã‚¤ãƒˆãƒ« -->
<div id="s-title" class="screen active">
    <h1>SMASH<br>BREAKER</h1>
    <div class="desc">ãœã‚“ã¾ã„å¼ãƒãƒ£ãƒ¼ã‚¸ï¼†ã‚¹ãƒãƒƒã‚·ãƒ¥<br>ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å®Œå…¨å¯¾å¿œç‰ˆ</div>
    
    <button class="btn" onclick="Game.initLocal()">SOLO / LOCAL 2P</button>
    <button class="btn btn-accent" onclick="Net.open()">ONLINE BATTLE</button>
    
    <div style="margin-top:20px; font-size:0.8rem; color:#888; text-align:left; display:inline-block;">
        [P1] çŸ¢å°ã‚­ãƒ¼(ç§»å‹•/å›è»¢) + å³Shift(ãƒãƒ£ãƒ¼ã‚¸)<br>
        [P2] WASD(ç§»å‹•/å›è»¢) + å·¦Shift(ãƒãƒ£ãƒ¼ã‚¸)
    </div>
</div>

<!-- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ -->
<div id="s-net" class="screen">
    <h2>ONLINE MODE</h2>
    <div id="net-menu" style="display:flex; flex-direction:column;">
        <button class="btn" onclick="Net.host()">ROOM CREATE</button>
        <button class="btn btn-accent" onclick="Net.guest()">JOIN ROOM</button>
        <button class="btn" style="border-color:#555; color:#aaa;" onclick="location.reload()">BACK</button>
    </div>
    
    <div id="net-host-ui" style="display:none; flex-direction:column; align-items:center;">
        <div id="qr-view"></div>
        <div>ID: <span id="host-id" style="color:var(--primary); font-weight:bold;">...</span></div>
        <div style="color:var(--accent); margin-top:10px; animation:blink 1s infinite;">WAITING...</div>
    </div>

    <div id="net-guest-ui" style="display:none; flex-direction:column; align-items:center;">
        <div id="cam-view"></div>
        <button class="btn" onclick="Net.startCam()">ğŸ“· CAMERA</button>
        <input type="text" id="join-id" class="input-code" placeholder="Host ID">
        <button class="btn btn-accent" onclick="Net.joinInput()">CONNECT</button>
    </div>
</div>

<!-- ã‚²ãƒ¼ãƒ  -->
<div id="s-game" class="screen">
    <div id="game-wrapper">
        <canvas id="cvs"></canvas>
        <div class="hud">
            <div>P1: <span id="score-p1">0</span></div>
            <div>P2: <span id="score-p2">0</span></div>
        </div>
        <div class="controls-guide" id="guide-text"></div>
        
        <!-- çµæœ -->
        <div id="res-modal" class="modal">
            <h2 id="res-msg">WIN!</h2>
            <button class="btn btn-accent" onclick="location.reload()">TITLE</button>
        </div>
        
        <!-- å¾…æ©Ÿ -->
        <div id="wait-modal" class="modal">
            <h2>WAITING...</h2>
        </div>
    </div>
</div>

<script>
/**
 * SMASH BREAKER - ZENMAI EDITION
 * ç‰©ç†æŒ™å‹•ãƒ»æ“ä½œæ€§å®Œå…¨ä¿®æ­£ç‰ˆ
 */

// --- éŸ³å£°ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼ ---
const AudioSys = {
    ctx: null,
    init() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); },
    play(type) {
        if(!this.ctx) return;
        const t = this.ctx.currentTime;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.connect(g); g.connect(this.ctx.destination);
        
        if(type==='hit') { // é€šå¸¸ãƒ’ãƒƒãƒˆ
            o.type='square'; o.frequency.setValueAtTime(400, t);
            g.gain.exponentialRampToValueAtTime(0.01, t+0.1);
            o.start(); o.stop(t+0.1);
        } else if(type==='wind') { // ãœã‚“ã¾ã„å·»ãä¸Šã’ï¼ˆã‚«ãƒªã‚«ãƒªéŸ³ï¼‰
            o.type='sawtooth'; o.frequency.setValueAtTime(100, t);
            g.gain.setValueAtTime(0.1, t); g.gain.linearRampToValueAtTime(0, t+0.05);
            o.start(); o.stop(t+0.05);
        } else if(type==='smash') { // ã‚¹ãƒãƒƒã‚·ãƒ¥ç™ºå°„
            o.type='sawtooth'; o.frequency.setValueAtTime(200, t); o.frequency.linearRampToValueAtTime(50, t+0.3);
            g.gain.setValueAtTime(0.5, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.3);
            o.start(); o.stop(t+0.3);
        } else if(type==='break') { // ç ´å£Š
            o.type='square'; o.frequency.setValueAtTime(150, t);
            g.gain.exponentialRampToValueAtTime(0.01, t+0.2);
            o.start(); o.stop(t+0.2);
        } else if(type==='win') { 
            o.type='triangle'; o.frequency.setValueAtTime(523, t);
            g.gain.linearRampToValueAtTime(0, t+1.0);
            o.start(); o.stop(t+1.0);
        }
    }
};

// --- å…¥åŠ›ç®¡ç† (P1/P2å®Œå…¨åˆ†é›¢) ---
const Input = {
    p1: { x:0, rot:0, charge:false }, // Arrow, R-Shift
    p2: { x:0, rot:0, charge:false }, // WASD, L-Shift
    
    init() {
        window.addEventListener('keydown', e => this.handle(e, true));
        window.addEventListener('keyup', e => this.handle(e, false));
    },
    
    handle(e, isDown) {
        const code = e.code;
        // P1 Controls (Arrows + Right Shift)
        if(code==='ArrowLeft') this.p1.x = isDown ? -1 : 0;
        if(code==='ArrowRight') this.p1.x = isDown ? 1 : 0;
        if(code==='ArrowUp') this.p1.rot = isDown ? -1 : 0; // å·¦å‚¾ã‘
        if(code==='ArrowDown') this.p1.rot = isDown ? 1 : 0; // å³å‚¾ã‘
        if(code==='ShiftRight') this.p1.charge = isDown;

        // P2 Controls (WASD + Left Shift)
        if(code==='KeyA') this.p2.x = isDown ? -1 : 0;
        if(code==='KeyD') this.p2.x = isDown ? 1 : 0;
        if(code==='KeyW') this.p2.rot = isDown ? -1 : 0;
        if(code==='KeyS') this.p2.rot = isDown ? 1 : 0;
        if(code==='ShiftLeft') this.p2.charge = isDown;
        
        // Prevent scrolling with arrows
        if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(code)) e.preventDefault();
    }
};

// --- ãƒ‘ãƒ‰ãƒ«ã‚¯ãƒ©ã‚¹ (ãœã‚“ã¾ã„å¼) ---
class Paddle {
    constructor(x, y, color) {
        this.x = x; this.y = y; 
        this.w = 100; this.h = 15;
        this.color = color;
        this.angle = 0; // ç¾åœ¨ã®è§’åº¦
        this.baseAngle = 0; // å‚¾ãæ“ä½œã«ã‚ˆã‚‹åŸºæº–è§’åº¦
        
        // ãœã‚“ã¾ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
        this.windUp = 0; // å·»ãä¸Šã’é‡ (0-100)
        this.spinVel = 0; // è§£æ”¾æ™‚ã®å›è»¢é€Ÿåº¦
        this.isSmashing = false; // ã‚¹ãƒãƒƒã‚·ãƒ¥åˆ¤å®šä¸­ã‹
    }
    
    update(inp) {
        // ç§»å‹•
        this.x += inp.x * 8;
        this.x = Math.max(this.w/2, Math.min(600-this.w/2, this.x)); // ç”»é¢ç«¯
        
        // å›è»¢ï¼ˆãƒãƒ«ãƒˆï¼‰æ“ä½œ: ã‚­ãƒ¼å…¥åŠ›ã§åŸºæº–è§’åº¦ã‚’å¤‰ãˆã‚‹
        if(inp.rot !== 0) {
            this.baseAngle += inp.rot * 0.05;
            this.baseAngle = Math.max(-0.6, Math.min(0.6, this.baseAngle));
        } else {
            this.baseAngle *= 0.9; // æ“ä½œã—ã¦ãªã„ã¨æˆ»ã‚‹
        }

        // ãœã‚“ã¾ã„ãƒ­ã‚¸ãƒƒã‚¯
        if (inp.charge) {
            // ãƒãƒ£ãƒ¼ã‚¸ä¸­: é€†æ–¹å‘ã«ã‚†ã£ãã‚Šå·»ã
            this.windUp = Math.min(100, this.windUp + 2);
            // è¦–è¦šçš„ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ: éœ‡ãˆã‚‹ & é€†å›è»¢
            const shake = (Math.random() - 0.5) * (this.windUp/200);
            this.angle = this.baseAngle + (this.windUp / 100) * Math.PI + shake; // 180åº¦ã¾ã§å·»ãã‚¤ãƒ¡ãƒ¼ã‚¸
            
            // éŸ³ (ã‚«ãƒªã‚«ãƒªéŸ³)
            if(this.windUp < 100 && this.windUp % 10 === 0) AudioSys.play('wind');
            
        } else {
            // è§£æ”¾æ™‚
            if (this.windUp > 0) {
                // æºœã¾ã£ãŸåˆ†ã‚’å›è»¢é€Ÿåº¦ã«å¤‰æ›
                this.spinVel = -(this.windUp / 100) * 1.5; // é€†æ–¹å‘ã«çŒ›çƒˆã‚¹ãƒ”ãƒ³
                this.windUp = 0;
                this.isSmashing = true;
                AudioSys.play('smash');
                
                // ã‚¹ãƒãƒƒã‚·ãƒ¥çŠ¶æ…‹ã¯çŸ­æ™‚é–“
                setTimeout(() => { this.isSmashing = false; }, 400);
            }
            
            // ã‚¹ãƒ”ãƒ³æ¸›è¡° & åŸºæº–è§’åº¦ã¸ã®å¾©å¸°
            this.angle += this.spinVel;
            this.spinVel *= 0.85; // æ‘©æ“¦
            
            // ç‰©ç†çš„ãªæˆ»ã‚Š
            this.angle += (this.baseAngle - this.angle) * 0.2;
        }
    }
    
    draw(ctx) {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        
        // ã‚¹ãƒãƒƒã‚·ãƒ¥ä¸­ã¯ç™ºå…‰
        if(this.isSmashing || this.windUp > 80) {
            ctx.shadowBlur = 20;
            ctx.shadowColor = this.color;
        }
        
        ctx.fillStyle = this.color;
        ctx.fillRect(-this.w/2, -this.h/2, this.w, this.h);
        
        // è»¸
        ctx.fillStyle = "#fff";
        ctx.beginPath(); ctx.arc(0, 0, 5, 0, Math.PI*2); ctx.fill();
        
        ctx.restore();
    }
}

// --- ã‚²ãƒ¼ãƒ æœ¬ä½“ ---
const Game = {
    canvas: null, ctx: null, loopId: null,
    width: 600, height: 800,
    
    mode: 'local', // local, online
    role: 'p1', // p1(host), p2(guest)
    state: 'stop',
    
    p1: null, p2: null, ball: null, blocks: [],
    
    initLocal() {
        this.mode = 'local';
        this.role = 'p1';
        document.getElementById('guide-text').innerHTML = "P1: çŸ¢å°+å³Shift | P2: WASD+å·¦Shift";
        this.start();
    },
    
    initOnline(isHost) {
        this.mode = 'online';
        this.role = isHost ? 'p1' : 'p2';
        document.getElementById('guide-text').innerHTML = isHost ? "YOU: P1 (çŸ¢å°+å³Shift)" : "YOU: P2 (WASD+å·¦Shift)";
        this.start();
    },
    
    start() {
        AudioSys.init();
        Input.init();
        document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
        document.getElementById('s-game').classList.add('active');
        document.getElementById('res-modal').style.display='none';
        document.getElementById('wait-modal').style.display='none';
        
        this.canvas = document.getElementById('cvs');
        this.ctx = this.canvas.getContext('2d');
        this.canvas.width = 600; this.canvas.height = 800;
        
        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ
        this.p1 = new Paddle(300, 750, '#00ffff');
        this.p2 = new Paddle(300, 50, '#ff0055');
        
        this.resetBall();
        this.createBlocks();
        
        this.state = 'play';
        if(this.loopId) cancelAnimationFrame(this.loopId);
        this.loop();
    },
    
    resetBall() {
        this.ball = { x:300, y:400, r:10, vx:0, vy:0, isSmash:false };
        // æœ€åˆã¯ã‚†ã£ãã‚Š
        const a = Math.PI/2 + (Math.random()-0.5);
        const speed = 6;
        this.ball.vx = Math.cos(a) * speed;
        this.ball.vy = Math.sin(a) * speed * (this.role==='p1'?1:-1);
        
        // Online Guestã¯ãƒœãƒ¼ãƒ«è¨ˆç®—ã—ãªã„ï¼ˆåŒæœŸå¾…ã¤ï¼‰
        if(this.mode==='online' && this.role==='p2') { this.ball.vx=0; this.ball.vy=0; }
    },
    
    createBlocks() {
        this.blocks = [];
        // ä¸­å¤®ã«å°‘ã—ã ã‘é…ç½®ï¼ˆå¯¾æˆ¦ã®é‚ªé­”ã«ãªã‚‰ãªã„ç¨‹åº¦ï¼‰
        for(let i=0; i<5; i++) {
            this.blocks.push({
                x: 100 + i*100, y: 400, w: 80, h: 20, color: '#ffff00', active:true
            });
        }
    },
    
    loop() {
        if(this.state !== 'play') return;
        
        this.update();
        this.draw();
        
        if(this.mode === 'online') this.sync();
        this.loopId = requestAnimationFrame(()=>this.loop());
    },
    
    update() {
        // ãƒ‘ãƒ‰ãƒ«æ›´æ–°
        if(this.mode === 'local') {
            this.p1.update(Input.p1);
            this.p2.update(Input.p2);
        } else {
            // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³: è‡ªåˆ†ã®ã‚­ãƒ£ãƒ©ã ã‘æ“ä½œã€ç›¸æ‰‹ã¯ãƒ‡ãƒ¼ã‚¿å—ä¿¡ã§å‹•ã
            if(this.role === 'p1') this.p1.update(Input.p1);
            else this.p2.update(Input.p2);
        }
        
        // ç‰©ç† (Local ã¾ãŸã¯ Host ã®ã¿è¨ˆç®—)
        if(this.mode === 'local' || (this.mode === 'online' && this.role === 'p1')) {
            this.updatePhysics();
        }
    },
    
    updatePhysics() {
        const b = this.ball;
        const spd = b.isSmash ? 1.5 : 1.0; // ã‚¹ãƒãƒƒã‚·ãƒ¥æ™‚ã¯é«˜é€ŸåŒ–
        
        b.x += b.vx * spd;
        b.y += b.vy * spd;
        
        // å£
        if(b.x < b.r || b.x > 600-b.r) b.vx *= -1;
        
        // ãƒ‘ãƒ‰ãƒ«è¡çª (å›è»¢è¡Œåˆ—ã§OBBåˆ¤å®š)
        this.checkPaddleHit(this.p1);
        this.checkPaddleHit(this.p2);
        
        // ãƒ–ãƒ­ãƒƒã‚¯
        this.blocks.forEach(blk => {
            if(!blk.active) return;
            if(b.x > blk.x && b.x < blk.x+blk.w && b.y > blk.y && b.y < blk.y+blk.h) {
                if(!b.isSmash) b.vy *= -1; // ã‚¹ãƒãƒƒã‚·ãƒ¥ã¯è²«é€š
                blk.active = false;
                AudioSys.play('break');
            }
        });
        
        // ã‚´ãƒ¼ãƒ«åˆ¤å®š
        if(b.y > 800) this.goal('p2');
        if(b.y < 0) this.goal('p1');
    },
    
    // å›è»¢ãƒ‘ãƒ‰ãƒ«ã¨ã®è¡çªè¨ˆç®—
    checkPaddleHit(p) {
        const b = this.ball;
        
        // ãƒœãƒ¼ãƒ«åº§æ¨™ã‚’ãƒ‘ãƒ‰ãƒ«ä¸­å¿ƒã‚’åŸç‚¹ã¨ã—ã€ãƒ‘ãƒ‰ãƒ«è§’åº¦åˆ†é€†å›è»¢ã•ã›ãŸåº§æ¨™ç³»ã«å¤‰æ›
        const dx = b.x - p.x;
        const dy = b.y - p.y;
        const cos = Math.cos(-p.angle);
        const sin = Math.sin(-p.angle);
        const localX = dx * cos - dy * sin;
        const localY = dx * sin + dy * cos;
        
        // AABBåˆ¤å®š (ãƒ­ãƒ¼ã‚«ãƒ«åº§æ¨™ç³»)
        if (localX > -p.w/2 - b.r && localX < p.w/2 + b.r &&
            localY > -p.h/2 - b.r && localY < p.h/2 + b.r) {
            
            // è¡çªï¼
            // ã‚¹ãƒãƒƒã‚·ãƒ¥åˆ¤å®š: ãƒ‘ãƒ‰ãƒ«ãŒé«˜é€Ÿå›è»¢ä¸­ãªã‚‰ã‚¹ãƒãƒƒã‚·ãƒ¥åŒ–
            if(p.isSmashing) {
                b.isSmash = true;
                // ã‚¹ãƒãƒƒã‚·ãƒ¥æ™‚ã¯è¶…åŠ é€Ÿ
                const speed = 15;
                // è§’åº¦ã¯ãƒ‘ãƒ‰ãƒ«ã®å‘ãã«ä¾å­˜
                const smashAng = p.angle - Math.PI/2; // ä¸Šå‘ãåŸºæº–
                b.vx = Math.cos(smashAng) * speed + (localX/p.w)*5; // æ¨ªä½ç½®ã§ã‚«ãƒ¼ãƒ–
                b.vy = Math.sin(smashAng) * speed; 
                if(p === this.p2) b.vy = Math.abs(b.vy); // P2ã¯ä¸‹ã¸
                else b.vy = -Math.abs(b.vy);             // P1ã¯ä¸Šã¸
                
                AudioSys.play('smash');
                
            } else {
                // é€šå¸¸åå°„
                // Yé€Ÿåº¦åè»¢ + ãƒ‘ãƒ‰ãƒ«ã®å›è»¢é€Ÿåº¦ã‚’åŠ ç®—ï¼ˆã‚¹ãƒ”ãƒ³ï¼‰
                // ç°¡æ˜“è¨ˆç®—: ãƒ­ãƒ¼ã‚«ãƒ«Yã‚’åè»¢ã—ã¦ãƒ¯ãƒ¼ãƒ«ãƒ‰ã«æˆ»ã™
                const vCos = Math.cos(p.angle);
                const vSin = Math.sin(p.angle);
                
                // å‚ç›´æˆåˆ†ã‚’åè»¢
                // ç°¡æ˜“çš„ã«ã€æ³•ç·šãƒ™ã‚¯ãƒˆãƒ«ã‚’ä½¿ã£ã¦åå°„ã•ã›ã‚‹
                const nx = Math.sin(p.angle); // ãƒ‘ãƒ‰ãƒ«é¢ã®æ³•ç·šX
                const ny = -Math.cos(p.angle); // ãƒ‘ãƒ‰ãƒ«é¢ã®æ³•ç·šY
                
                const dot = b.vx * nx + b.vy * ny;
                b.vx = b.vx - 2 * dot * nx;
                b.vy = b.vy - 2 * dot * ny;
                
                // å°‘ã—åŠ é€Ÿ
                b.vx *= 1.05; b.vy *= 1.05;
                b.isSmash = false;
                
                AudioSys.play('hit');
                
                // ã‚ã‚Šè¾¼ã¿é˜²æ­¢ï¼ˆæŠ¼ã—å‡ºã—ï¼‰
                b.x += b.vx * 2;
                b.y += b.vy * 2;
            }
        }
    },
    
    goal(winner) {
        if(this.mode === 'online') {
            Net.send({ type:'over', winner:winner });
        }
        this.gameOver(winner);
    },
    
    gameOver(winner) {
        this.state = 'stop';
        document.getElementById('res-modal').style.display='flex';
        let msg = "";
        if(this.mode === 'local') {
            msg = (winner==='p1' ? "P1 WIN!" : "P2 WIN!");
        } else {
            msg = (winner===this.role ? "YOU WIN!" : "YOU LOSE...");
        }
        document.getElementById('res-msg').innerText = msg;
        AudioSys.play('win');
    },
    
    draw() {
        const ctx = this.ctx;
        ctx.fillStyle = '#000';
        ctx.fillRect(0,0,600,800);
        
        // ãƒ–ãƒ­ãƒƒã‚¯
        this.blocks.forEach(b => {
            if(b.active) {
                ctx.fillStyle = b.color;
                ctx.fillRect(b.x, b.y, b.w, b.h);
            }
        });
        
        // ãƒ‘ãƒ‰ãƒ«
        this.p1.draw(ctx);
        this.p2.draw(ctx);
        
        // ãƒœãƒ¼ãƒ«
        ctx.fillStyle = this.ball.isSmash ? '#ffff00' : '#fff';
        if(this.ball.isSmash) {
            ctx.shadowBlur = 20; ctx.shadowColor = '#ffff00';
        }
        ctx.beginPath();
        ctx.arc(this.ball.x, this.ball.y, this.ball.r, 0, Math.PI*2);
        ctx.fill();
        ctx.shadowBlur = 0;
    },
    
    // --- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åŒæœŸ ---
    sync() {
        if(this.role === 'p1') {
            // ãƒ›ã‚¹ãƒˆ: å…¨çŠ¶æ…‹é€ä¿¡
            Net.send({
                type: 'sync',
                p1: { x:this.p1.x, a:this.p1.angle, w:this.p1.windUp, s:this.p1.isSmashing },
                b: this.ball,
                bl: this.blocks.map(b=>b.active) // ãƒ–ãƒ­ãƒƒã‚¯çŠ¶æ…‹
            });
        } else {
            // ã‚²ã‚¹ãƒˆ: è‡ªåˆ†ã®å…¥åŠ›çŠ¶æ…‹é€ä¿¡
            Net.send({
                type: 'input',
                p2: { x:this.p2.x, a:this.p2.angle, w:this.p2.windUp, s:this.p2.isSmashing }
            });
        }
    },
    
    onNetData(d) {
        if(d.type === 'sync') {
            // ã‚²ã‚¹ãƒˆå—ä¿¡: P1(ç›¸æ‰‹)ã¨ãƒœãƒ¼ãƒ«ã¨ãƒ–ãƒ­ãƒƒã‚¯ã‚’æ›´æ–°
            this.p1.x = d.p1.x; this.p1.angle = d.p1.a; this.p1.windUp = d.p1.w; this.p1.isSmashing = d.p1.s;
            this.ball = d.b;
            if(d.bl) d.bl.forEach((act, i) => { if(this.blocks[i]) this.blocks[i].active = act; });
        } else if(d.type === 'input') {
            // ãƒ›ã‚¹ãƒˆå—ä¿¡: P2(ç›¸æ‰‹)ã®å‹•ãã‚’æ›´æ–°
            this.p2.x = d.p2.x; this.p2.angle = d.p2.a; this.p2.windUp = d.p2.w; this.p2.isSmashing = d.p2.s;
        } else if(d.type === 'over') {
            this.gameOver(d.winner);
        }
    }
};

// --- é€šä¿¡ã‚¯ãƒ©ã‚¹ ---
const Net = {
    peer: null, conn: null, scanner: null,
    
    open() {
        document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
        document.getElementById('s-net').classList.add('active');
        document.getElementById('net-menu').style.display='flex';
        document.getElementById('net-host-ui').style.display='none';
        document.getElementById('net-guest-ui').style.display='none';
    },
    
    host() {
        document.getElementById('net-menu').style.display='none';
        document.getElementById('net-host-ui').style.display='flex';
        this.peer = new Peer();
        this.peer.on('open', id => {
            document.getElementById('host-id').innerText = id;
            document.getElementById('qr-view').innerHTML = '';
            new QRCode(document.getElementById("qr-view"), { text:id, width:150, height:150 });
        });
        this.peer.on('connection', c => {
            this.conn = c; this.setup();
            Game.initOnline(true);
        });
    },
    
    guest() {
        document.getElementById('net-menu').style.display='none';
        document.getElementById('net-guest-ui').style.display='flex';
    },
    
    startCam() {
        document.getElementById('cam-view').style.display='block';
        this.scanner = new Html5QrcodeScanner("cam-view", { fps:10, qrbox:200 });
        this.scanner.render(id => {
            this.join(id);
            this.scanner.clear();
            document.getElementById('cam-view').style.display='none';
        });
    },
    
    joinInput() {
        const id = document.getElementById('join-id').value;
        if(id) this.join(id);
    },
    
    join(id) {
        this.peer = new Peer();
        this.peer.on('open', () => {
            this.conn = this.peer.connect(id);
            this.setup();
            Game.initOnline(false);
        });
    },
    
    setup() {
        this.conn.on('data', d => Game.onNetData(d));
        this.conn.on('open', () => console.log('Connected'));
        this.conn.on('close', () => alert('Disconneted'));
    },
    
    send(d) { if(this.conn && this.conn.open) this.conn.send(d); }
};

</script>
</body>
</html>
