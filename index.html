<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚«ãƒ«ã‚¯ï¼†ã‚¯ãƒ©ãƒƒã‚·ãƒ¥</title>
    
    <!-- å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">

<style>
:root {
    --bg-color: #eef2f5;
    --text-color: #2c3e50;
    --primary: #3498db; /* é’ */
    --accent: #e74c3c;  /* èµ¤ */
    --success: #2ecc71; /* ç·‘ */
    --warning: #f1c40f; /* é»„ */
    --canvas-bg: #1a1a2e;
}

body {
    margin: 0; background: var(--bg-color); color: var(--text-color);
    font-family: 'M PLUS Rounded 1c', sans-serif;
    height: 100vh; overflow: hidden; touch-action: none; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
    display: flex; justify-content: center; align-items: center;
}

/* ç”»é¢ç®¡ç† */
.screen {
    position: absolute; width: 100%; height: 100%;
    display: none; flex-direction: column; align-items: center; justify-content: center;
    background: var(--bg-color); z-index: 1;
}
.screen.active { display: flex; z-index: 10; }

/* UIãƒ‘ãƒ¼ãƒ„ */
h1 { font-size: 2.5rem; margin-bottom: 10px; text-align: center; color: #34495e; text-shadow: 2px 2px 0px rgba(0,0,0,0.1); }
h2 { font-size: 1.5rem; margin-bottom: 20px; }

.btn {
    width: 80%; max-width: 320px; padding: 16px; margin: 8px;
    border: none; border-radius: 50px;
    font-size: 1.2rem; font-weight: bold; cursor: pointer;
    box-shadow: 0 4px 0 rgba(0,0,0,0.1); transition: transform 0.1s;
    background: #fff; color: #555; border: 2px solid #ddd;
}
.btn:active { transform: translateY(4px); box-shadow: none; }
.btn-primary { background: var(--primary); color: #fff; border: none; box-shadow: 0 4px 0 #2980b9; }
.btn-accent { background: var(--accent); color: #fff; border: none; box-shadow: 0 4px 0 #c0392b; }
.btn-success { background: var(--success); color: #fff; border: none; box-shadow: 0 4px 0 #27ae60; }

.input-box {
    font-size: 1.2rem; padding: 12px; width: 70%; text-align: center;
    border: 2px solid #ccc; border-radius: 8px; margin: 10px 0;
}

/* ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç”»é¢ */
#qr-display { background: #fff; padding: 15px; border-radius: 10px; margin: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
#camera-wrapper { width: 90%; max-width: 300px; margin: 10px; border: 4px solid #333; border-radius: 8px; overflow: hidden; display: none; }

/* ã‚²ãƒ¼ãƒ ã‚­ãƒ£ãƒ³ãƒã‚¹ */
#game-container {
    position: relative; width: 100%; height: 100%; max-width: 600px;
    background: #000; box-shadow: 0 0 20px rgba(0,0,0,0.3);
}
canvas { display: block; width: 100%; height: 100%; touch-action: none; }

/* HUD (ã‚¹ã‚³ã‚¢ãªã©) */
.hud {
    position: absolute; top: 10px; left: 0; width: 100%;
    display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box;
    pointer-events: none; color: #fff; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    z-index: 5; font-size: 1.2rem;
}

/* ã‚¨ãƒ‡ã‚£ã‚¿ç”»é¢ */
.editor-grid {
    display: grid; grid-template-columns: repeat(16, 1fr);
    width: 320px; height: 320px; background: #333; border: 4px solid #555;
    margin-bottom: 20px; touch-action: none;
}
.pixel { border: 1px solid rgba(255,255,255,0.05); background: transparent; }
.palette { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; width: 320px; }
.color-swatch { width: 35px; height: 35px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
.color-swatch.active { transform: scale(1.2); border-color: #333; }
.eraser { background: 
    repeating-linear-gradient(45deg, #ccc, #ccc 5px, #fff 5px, #fff 10px); 
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal {
    position: absolute; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.85); z-index: 20;
    display: none; flex-direction: column; justify-content: center; align-items: center;
    color: #fff;
}
.modal h2 { font-size: 3rem; margin-bottom: 10px; text-shadow: 0 0 10px var(--warning); }
.score-result { font-size: 1.5rem; margin-bottom: 30px; font-family: monospace; }

</style>
</head>
<body>

<!-- 1. ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
<div id="screen-title" class="screen active">
    <h1>ã‚¹ãƒãƒƒã‚·ãƒ¥<br>ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼</h1>
    <div style="font-size:0.9rem; color:#888; margin-bottom:20px;">ç›´æ„Ÿæ“ä½œãƒ–ãƒ­ãƒƒã‚¯å´©ã—</div>
    
    <button class="btn btn-primary" onclick="Game.startLocal()">ã²ã¨ã‚Šã§éŠã¶</button>
    <button class="btn btn-accent" onclick="Network.openMenu()">ãµãŸã‚Šã§å¯¾æˆ¦ (é€šä¿¡)</button>
    <button class="btn btn-success" onclick="Editor.open()">æ©Ÿä½“ã‚’ã¤ãã‚‹</button>
</div>

<!-- 2. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
<div id="screen-network" class="screen">
    <h2>é€šä¿¡å¯¾æˆ¦</h2>
    
    <div id="net-select" style="width:100%; display:flex; flex-direction:column; align-items:center;">
        <button class="btn btn-primary" onclick="Network.initHost()">éƒ¨å±‹ã‚’ã¤ãã‚‹ (ãƒ›ã‚¹ãƒˆ)</button>
        <div style="margin:10px;">ã¾ãŸã¯</div>
        <button class="btn btn-accent" onclick="Network.showGuest()">éƒ¨å±‹ã«å…¥ã‚‹ (ã‚²ã‚¹ãƒˆ)</button>
        <button class="btn" onclick="location.reload()" style="margin-top:20px;">ã‚‚ã©ã‚‹</button>
    </div>

    <!-- ãƒ›ã‚¹ãƒˆç”»é¢ -->
    <div id="net-host" style="display:none; flex-direction:column; align-items:center; width:100%;">
        <p>ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’ç›¸æ‰‹ã«è¦‹ã›ã¦ãã ã•ã„</p>
        <div id="qr-display"></div>
        <div style="margin-bottom:20px;">ID: <span id="host-id-text" style="font-weight:bold;">ç”Ÿæˆä¸­...</span></div>
        <div style="color:var(--accent); font-weight:bold; animation:blink 1s infinite;">ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
        <button class="btn" onclick="location.reload()" style="margin-top:20px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>

    <!-- ã‚²ã‚¹ãƒˆç”»é¢ -->
    <div id="net-guest" style="display:none; flex-direction:column; align-items:center; width:100%;">
        <div id="camera-wrapper"></div>
        <button class="btn btn-primary" onclick="Network.startCamera()">ğŸ“· QRã‚’èª­ã¿å–ã‚‹</button>
        <div style="margin:10px;">ã¾ãŸã¯</div>
        <input type="text" id="input-id" class="input-box" placeholder="æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
        <button class="btn btn-accent" onclick="Network.joinByInput()">ã‚³ãƒ¼ãƒ‰ã§å‚åŠ </button>
        <button class="btn" onclick="location.reload()" style="margin-top:20px;">ã‚‚ã©ã‚‹</button>
    </div>
</div>

<!-- 3. ã‚¨ãƒ‡ã‚£ã‚¿ç”»é¢ -->
<div id="screen-editor" class="screen">
    <h2>ãƒ‘ãƒ‰ãƒ«å·¥æˆ¿</h2>
    <div id="editor-grid" class="editor-grid"></div>
    <div id="palette" class="palette"></div>
    <div style="display:flex; gap:10px; width:90%; justify-content:center;">
        <button class="btn btn-primary" onclick="Editor.saveAndExit()">ä¿å­˜ã—ã¦æˆ»ã‚‹</button>
        <button class="btn" onclick="Editor.clear()">ã‚¯ãƒªã‚¢</button>
    </div>
    <button class="btn" style="margin-top:10px; background:transparent; border:none;" onclick="Editor.close()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<!-- 4. ã‚²ãƒ¼ãƒ ç”»é¢ -->
<div id="screen-game" class="screen" style="background:#000;">
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        <div class="hud">
            <div id="hud-left">STAGE 1</div>
            <div id="hud-right">SCORE: 0</div>
        </div>
        
        <!-- çµæœãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="result-modal" class="modal">
            <h2 id="result-title">GAME OVER</h2>
            <div id="result-score" class="score-result">SCORE: 1000</div>
            <button class="btn btn-primary" onclick="Game.retry()">ã‚‚ã†ä¸€åº¦</button>
            <button class="btn" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
        </div>
        
        <!-- å¾…æ©Ÿã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
        <div id="wait-overlay" class="modal" style="background:rgba(0,0,0,0.5);">
            <h2 style="font-size:1.5rem;">ç›¸æ‰‹ã‚’å¾…ã£ã¦ã„ã¾ã™...</h2>
        </div>
    </div>
</div>

<style>
@keyframes blink { 50% { opacity: 0.5; } }
</style>

<script>
/**
 * SMASH BREAKER - COMPLETE EDITION
 * æ—¥æœ¬èªåŒ–ãƒ»æ“ä½œæ€§æ”¹å–„ãƒ»QRå¯¾å¿œ
 */

// --- éŸ³å£°ç®¡ç† (ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆ) ---
const Sound = {
    ctx: null,
    init() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); },
    play(type) {
        if(!this.ctx) return;
        const t = this.ctx.currentTime;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.connect(g); g.connect(this.ctx.destination);

        if(type === 'hit') { // ãƒœãƒ¼ãƒ«ãƒ’ãƒƒãƒˆ
            o.type = 'square'; o.frequency.setValueAtTime(400, t);
            g.gain.exponentialRampToValueAtTime(0.01, t+0.1);
            o.start(); o.stop(t+0.1);
        } else if(type === 'break') { // ãƒ–ãƒ­ãƒƒã‚¯ç ´å£Š
            o.type = 'sawtooth'; o.frequency.setValueAtTime(200, t);
            o.frequency.linearRampToValueAtTime(50, t+0.2);
            g.gain.exponentialRampToValueAtTime(0.01, t+0.2);
            o.start(); o.stop(t+0.2);
        } else if(type === 'paddle') { // ãƒ‘ãƒ‰ãƒ«åå°„
            o.type = 'sine'; o.frequency.setValueAtTime(800, t);
            g.gain.exponentialRampToValueAtTime(0.01, t+0.1);
            o.start(); o.stop(t+0.1);
        } else if(type === 'win') { // å‹åˆ©
            o.type = 'triangle';
            o.frequency.setValueAtTime(523, t); o.frequency.setValueAtTime(1046, t+0.2);
            g.gain.linearRampToValueAtTime(0, t+0.5);
            o.start(); o.stop(t+0.5);
        }
    }
};

// --- ãƒ‘ãƒ‰ãƒ«ãƒ‡ãƒ¼ã‚¿ (ã‚¨ãƒ‡ã‚£ã‚¿ç”¨) ---
const PaddleData = {
    pixels: new Array(16*16).fill(null), // 16x16 grid
    colors: ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6', '#ecf0f1', '#95a5a6', '#34495e', '#000000'],
    customized: false,
    
    renderToCanvas(ctx, x, y, w, h) {
        if(!this.customized) {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ã‚¶ã‚¤ãƒ³ (ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ãªãƒãƒ¼)
            ctx.fillStyle = '#3498db';
            ctx.beginPath();
            ctx.roundRect(x - w/2, y - h/2, w, h, 10);
            ctx.fill();
            // å…‰æ²¢
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.fillRect(x - w/2 + 5, y - h/2 + 2, w - 10, h/2 - 2);
        } else {
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒƒãƒˆçµµ
            const size = w / 16;
            const startX = x - w/2;
            const startY = y - w/2; // æ­£æ–¹å½¢ã¨ã—ã¦æç”»
            
            for(let i=0; i<256; i++) {
                if(this.pixels[i]) {
                    ctx.fillStyle = this.pixels[i];
                    const px = i % 16;
                    const py = Math.floor(i / 16);
                    ctx.fillRect(startX + px*size, startY + py*size, size, size);
                }
            }
        }
    }
};

// --- ã‚¨ãƒ‡ã‚£ã‚¿æ©Ÿèƒ½ ---
const Editor = {
    selectedColor: '#3498db',
    
    open() {
        document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
        document.getElementById('screen-editor').classList.add('active');
        this.initGrid();
        this.initPalette();
    },
    
    initGrid() {
        const grid = document.getElementById('editor-grid');
        grid.innerHTML = '';
        PaddleData.pixels.forEach((col, i) => {
            const div = document.createElement('div');
            div.className = 'pixel';
            if(col) div.style.backgroundColor = col;
            
            // ã‚¿ãƒƒãƒ/ãƒã‚¦ã‚¹æç”»
            const paint = () => { div.style.backgroundColor = this.selectedColor; PaddleData.pixels[i] = this.selectedColor; };
            div.onpointerdown = (e) => { e.releasePointerCapture(e.pointerId); paint(); };
            div.onpointerenter = (e) => { if(e.buttons===1) paint(); };
            
            grid.appendChild(div);
        });
    },
    
    initPalette() {
        const pal = document.getElementById('palette');
        pal.innerHTML = '';
        // ã‚«ãƒ©ãƒ¼
        PaddleData.colors.forEach(c => {
            const d = document.createElement('div');
            d.className = 'color-swatch';
            d.style.backgroundColor = c;
            d.onclick = () => { this.setColor(c, d); };
            if(c === this.selectedColor) d.classList.add('active');
            pal.appendChild(d);
        });
        // æ¶ˆã—ã‚´ãƒ 
        const e = document.createElement('div');
        e.className = 'color-swatch eraser';
        e.onclick = () => { this.setColor(null, e); };
        pal.appendChild(e);
    },
    
    setColor(c, el) {
        this.selectedColor = c;
        document.querySelectorAll('.color-swatch').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
    },
    
    clear() {
        PaddleData.pixels.fill(null);
        this.initGrid();
    },
    
    saveAndExit() {
        PaddleData.customized = PaddleData.pixels.some(c => c !== null);
        document.getElementById('screen-editor').classList.remove('active');
        document.getElementById('screen-title').classList.add('active');
    },
    
    close() {
        document.getElementById('screen-editor').classList.remove('active');
        document.getElementById('screen-title').classList.add('active');
    }
};

// --- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ©Ÿèƒ½ ---
const Network = {
    peer: null, conn: null, isHost: false, scanner: null,
    
    // ã€ä¿®æ­£ç®‡æ‰€ã€‘ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ãæ©Ÿèƒ½ã‚’è¿½åŠ 
    openMenu() {
        document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
        document.getElementById('screen-network').classList.add('active');
        document.getElementById('net-select').style.display='flex';
        document.getElementById('net-host').style.display='none';
        document.getElementById('net-guest').style.display='none';
    },

    initHost() {
        Sound.init();
        document.getElementById('net-select').style.display='none';
        document.getElementById('net-host').style.display='flex';
        
        this.peer = new Peer();
        this.peer.on('open', id => {
            document.getElementById('host-id-text').innerText = id;
            this.isHost = true;
            document.getElementById('qr-display').innerHTML = "";
            new QRCode(document.getElementById("qr-display"), { text: id, width: 160, height: 160 });
        });
        
        this.peer.on('connection', c => {
            this.conn = c;
            this.setupConn();
            Game.startOnline(true);
        });
    },
    
    showGuest() {
        document.getElementById('net-select').style.display='none';
        document.getElementById('net-guest').style.display='flex';
    },
    
    startCamera() {
        Sound.init();
        const wrap = document.getElementById('camera-wrapper');
        wrap.style.display = 'block';
        this.scanner = new Html5QrcodeScanner("camera-wrapper", { fps: 10, qrbox: 200 });
        this.scanner.render((decoded) => {
            this.join(decoded);
            this.scanner.clear();
            wrap.style.display = 'none';
        });
    },
    
    joinByInput() {
        const id = document.getElementById('input-id').value;
        if(id) this.join(id);
    },
    
    join(id) {
        Sound.init();
        this.peer = new Peer();
        this.peer.on('open', () => {
            this.conn = this.peer.connect(id);
            this.isHost = false;
            this.setupConn();
            Game.startOnline(false);
        });
        this.peer.on('error', () => alert("æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ"));
    },
    
    setupConn() {
        this.conn.on('data', d => Game.onNetworkData(d));
        this.conn.on('close', () => { alert("é€šä¿¡åˆ‡æ–­"); location.reload(); });
        this.conn.on('open', () => console.log("Connected"));
    },
    
    send(d) { if(this.conn && this.conn.open) this.conn.send(d); }
};

// --- ã‚²ãƒ¼ãƒ æœ¬ä½“ ---
const Game = {
    canvas: null, ctx: null, loopId: null,
    mode: 'local', // local, online
    role: 'p1', // p1(host), p2(guest)
    state: 'title', // playing, over
    
    width: 600, height: 800,
    
    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    p1: { x: 300, y: 750, w: 100, h: 20 },
    p2: { x: 300, y: 50, w: 100, h: 20 }, // å¯¾æˆ¦ç›¸æ‰‹
    ball: { x: 300, y: 400, r: 8, vx: 0, vy: 0, speed: 7 },
    blocks: [],
    
    score: 0, stage: 1,
    
    // å…¥åŠ›
    touchX: null,
    
    startLocal() {
        Sound.init();
        this.mode = 'local';
        this.role = 'p1';
        this.initGame();
    },
    
    startOnline(isHost) {
        this.mode = 'online';
        this.role = isHost ? 'p1' : 'p2';
        this.initGame();
    },
    
    initGame() {
        document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
        document.getElementById('screen-game').classList.add('active');
        document.getElementById('result-modal').style.display = 'none';
        document.getElementById('wait-overlay').style.display = 'none';
        
        this.canvas = document.getElementById('game-canvas');
        this.ctx = this.canvas.getContext('2d');
        
        // ã‚µã‚¤ã‚ºèª¿æ•´
        const rect = document.getElementById('game-container').getBoundingClientRect();
        this.canvas.width = this.width = rect.width;
        this.canvas.height = this.height = rect.height;
        
        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸé…ç½®
        this.p1.y = this.height - 50;
        this.p1.x = this.width / 2;
        this.p2.y = 50;
        this.p2.x = this.width / 2;
        
        this.setupStage(1);
        this.resetBall();
        
        // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
        this.canvas.onpointermove = (e) => {
            e.preventDefault();
            const rect = this.canvas.getBoundingClientRect();
            this.touchX = e.clientX - rect.left;
        };
        this.canvas.ontouchmove = (e) => {
            e.preventDefault();
            const rect = this.canvas.getBoundingClientRect();
            this.touchX = e.touches[0].clientX - rect.left;
        };
        
        this.state = 'playing';
        if(this.loopId) cancelAnimationFrame(this.loopId);
        this.loop();
    },
    
    setupStage(lvl) {
        this.stage = lvl;
        this.blocks = [];
        this.score = 0;
        
        if(this.mode === 'online') {
            // å¯¾æˆ¦ãƒ¢ãƒ¼ãƒ‰: ä¸­å¤®ã«éšœå®³ç‰©ã‚’é…ç½®ã—ãªã„
            return;
        }

        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: ãƒ–ãƒ­ãƒƒã‚¯é…ç½®
        const rows = 5 + lvl;
        const cols = 7;
        const bw = (this.width - 40) / cols;
        const bh = 25;
        
        for(let r=0; r<rows; r++) {
            for(let c=0; c<cols; c++) {
                if(Math.random() > 0.1) {
                    this.blocks.push({
                        x: 20 + c * bw,
                        y: 80 + r * bh,
                        w: bw - 4,
                        h: bh - 4,
                        hp: 1,
                        color: `hsl(${r * 40}, 70%, 60%)`
                    });
                }
            }
        }
    },
    
    resetBall() {
        this.ball.x = this.width / 2;
        this.ball.y = this.height / 2;
        this.ball.speed = 6 + (this.stage * 0.5);
        // ãƒ©ãƒ³ãƒ€ãƒ ãªè§’åº¦ã§ç™ºå°„
        const angle = Math.random() * Math.PI / 2 + (Math.PI / 4);
        this.ball.vx = Math.cos(angle) * this.ball.speed * (Math.random()>0.5?1:-1);
        this.ball.vy = Math.sin(angle) * this.ball.speed * (Math.random()>0.5?1:-1);
        
        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ›ã‚¹ãƒˆã®ã¿ãŒãƒœãƒ¼ãƒ«è¨ˆç®—ã‚’è¡Œã†
        if(this.mode === 'online' && this.role === 'p2') {
            this.ball.vx = 0; this.ball.vy = 0;
        }
    },
    
    loop() {
        if(this.state !== 'playing') return;
        
        this.update();
        this.draw();
        
        if(this.mode === 'online') {
            this.syncNetwork();
        }
        
        this.loopId = requestAnimationFrame(() => this.loop());
    },
    
    update() {
        // è‡ªæ©Ÿç§»å‹•
        if(this.touchX !== null) {
            // ã‚¹ãƒ ãƒ¼ã‚ºç§»å‹•
            this.p1.x += (this.touchX - this.p1.x) * 0.3;
        }
        // ç”»é¢ç«¯åˆ¶é™
        const hw = this.p1.w / 2;
        if(this.p1.x < hw) this.p1.x = hw;
        if(this.p1.x > this.width - hw) this.p1.x = this.width - hw;

        // ãƒœãƒ¼ãƒ«è¨ˆç®— (ãƒ­ãƒ¼ã‚«ãƒ« ã¾ãŸã¯ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ›ã‚¹ãƒˆ)
        if(this.mode === 'local' || (this.mode === 'online' && this.role === 'p1')) {
            this.updatePhysics();
        }
    },
    
    updatePhysics() {
        const b = this.ball;
        b.x += b.vx;
        b.y += b.vy;
        
        // å£åå°„
        if(b.x < b.r || b.x > this.width - b.r) b.vx *= -1;
        
        // P1ãƒ‘ãƒ‰ãƒ«åå°„
        if(this.hitRect(b, this.p1)) {
            b.vy = -Math.abs(b.vy);
            // æ‘©æ“¦ã‚’åŠ ãˆã‚‹ï¼ˆæ¨ªç§»å‹•ã®å½±éŸ¿ï¼‰
            b.vx += (b.x - this.p1.x) * 0.1;
            Sound.play('paddle');
        }
        
        // P2/CPUãƒ‘ãƒ‰ãƒ«åå°„
        if(this.mode === 'online') {
            if(this.hitRect(b, this.p2)) {
                b.vy = Math.abs(b.vy);
                b.vx += (b.x - this.p2.x) * 0.1;
                Sound.play('paddle');
            }
        } else {
            // ãƒ­ãƒ¼ã‚«ãƒ«ä¸Šå£
            if(b.y < b.r) b.vy *= -1;
        }
        
        // ãƒ–ãƒ­ãƒƒã‚¯è¡çª
        for(let i=this.blocks.length-1; i>=0; i--) {
            const blk = this.blocks[i];
            if(b.x > blk.x && b.x < blk.x + blk.w && b.y > blk.y && b.y < blk.y + blk.h) {
                b.vy *= -1;
                this.blocks.splice(i, 1);
                this.score += 100;
                Sound.play('break');
                break;
            }
        }
        
        // è½ä¸‹åˆ¤å®š
        if(b.y > this.height + 20) {
            if(this.mode === 'online') {
                this.gameOver("ã‚ãªãŸã®è² ã‘...");
                Network.send({ type: 'over', win: true }); // ç›¸æ‰‹ã«å‹ã¡ã‚’ä¼ãˆã‚‹
            } else {
                this.gameOver("GAME OVER");
            }
        }
        // å¤©äº•åˆ¤å®š (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã®ã¿)
        if(this.mode === 'online' && b.y < -20) {
            this.gameOver("ã‚ãªãŸã®å‹ã¡ï¼");
            Network.send({ type: 'over', win: false }); // ç›¸æ‰‹ã«è² ã‘ã‚’ä¼ãˆã‚‹
        }
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¯ãƒªã‚¢åˆ¤å®š
        if(this.mode === 'local' && this.blocks.length === 0) {
            this.setupStage(this.stage + 1);
            this.resetBall();
        }
    },
    
    hitRect(b, p) {
        return (b.x > p.x - p.w/2 && b.x < p.x + p.w/2 && 
                b.y > p.y - p.h/2 && b.y < p.y + p.h/2);
    },
    
    draw() {
        const ctx = this.ctx;
        ctx.clearRect(0, 0, this.width, this.height);
        
        // ãƒ–ãƒ­ãƒƒã‚¯
        this.blocks.forEach(b => {
            ctx.fillStyle = b.color;
            ctx.fillRect(b.x, b.y, b.w, b.h);
            ctx.strokeRect(b.x, b.y, b.w, b.h);
        });
        
        // ãƒ‘ãƒ‰ãƒ«
        PaddleData.renderToCanvas(ctx, this.p1.x, this.p1.y, this.p1.w, this.p1.h);
        if(this.mode === 'online') {
            // ç›¸æ‰‹ãƒ‘ãƒ‰ãƒ«ï¼ˆè‰²ã¯å›ºå®šï¼‰
            ctx.fillStyle = '#e74c3c';
            const x = this.p2.x, y = this.p2.y, w = this.p2.w, h = this.p2.h;
            ctx.fillRect(x - w/2, y - h/2, w, h);
        }
        
        // ãƒœãƒ¼ãƒ«
        ctx.beginPath();
        ctx.arc(this.ball.x, this.ball.y, this.ball.r, 0, Math.PI*2);
        ctx.fillStyle = '#fff';
        ctx.fill();
        
        // HUD
        document.getElementById('hud-right').innerText = "SCORE: " + this.score;
        if(this.mode === 'online') {
             document.getElementById('hud-left').innerText = this.role === 'p1' ? "ã‚ãªãŸ(ãƒ›ã‚¹ãƒˆ)" : "ã‚ãªãŸ(ã‚²ã‚¹ãƒˆ)";
        }
    },
    
    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åŒæœŸ
    syncNetwork() {
        if(this.role === 'p1') {
            // ãƒ›ã‚¹ãƒˆ: å…¨çŠ¶æ…‹ã‚’é€ã‚‹
            Network.send({
                type: 'sync',
                p1x: this.p1.x, // è‡ªåˆ†ã®ä½ç½®
                bx: this.ball.x, by: this.ball.y
            });
        } else {
            // ã‚²ã‚¹ãƒˆ: è‡ªåˆ†ã®ä½ç½®ã ã‘é€ã‚‹
            Network.send({
                type: 'input',
                x: this.p1.x // ç›¸æ‰‹ã‹ã‚‰è¦‹ã‚‹ã¨P2ã®ä½ç½®
            });
        }
    },
    
    onNetworkData(d) {
        if(d.type === 'sync') {
            // ã‚²ã‚¹ãƒˆ: ãƒ›ã‚¹ãƒˆã‹ã‚‰ã®æƒ…å ±ã§æ›´æ–°
            // ãƒ›ã‚¹ãƒˆã®P1ã¯ã€ã‚²ã‚¹ãƒˆç”»é¢ã§ã¯P2ã®ä½ç½®ï¼ˆä¸Šï¼‰ã«è¡¨ç¤º
            // åº§æ¨™å¤‰æ›: Xã¯ãã®ã¾ã¾ã€Yã¯åè»¢ã—ã¦è¡¨ç¤ºã—ãŸã„ãŒã€æç”»é–¢æ•°ã§p2.yã¯å›ºå®šã•ã‚Œã¦ã„ã‚‹ã®ã§Xã ã‘åŒæœŸ
            this.p2.x = d.p1x;
            this.ball.x = d.bx;
            this.ball.y = d.by;
        } else if(d.type === 'input') {
            // ãƒ›ã‚¹ãƒˆ: ã‚²ã‚¹ãƒˆã®å…¥åŠ›ã‚’åæ˜ 
            this.p2.x = d.x;
        } else if(d.type === 'over') {
            // å‹æ•—é€šçŸ¥
            this.gameOver(d.win ? "ã‚ãªãŸã®å‹ã¡ï¼" : "ã‚ãªãŸã®è² ã‘...");
        }
    },
    
    gameOver(msg) {
        this.state = 'over';
        document.getElementById('result-modal').style.display = 'flex';
        document.getElementById('result-title').innerText = msg;
        document.getElementById('result-score').innerText = "SCORE: " + this.score;
        Sound.play('win');
    },
    
    retry() {
        if(this.mode === 'online') {
            // å†æˆ¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆä»Šå›ã¯ç°¡æ˜“çš„ã«ãƒªãƒ­ãƒ¼ãƒ‰ã‚’ä¿ƒã™ï¼‰
            alert("é€šä¿¡å¯¾æˆ¦ã®å†æˆ¦ã¯ä¸€åº¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã£ã¦ãã ã•ã„");
            location.reload();
        } else {
            this.initGame();
        }
    }
};

</script>
</body>
</html>
