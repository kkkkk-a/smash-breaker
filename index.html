<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚¹ãƒãƒƒã‚·ãƒ¥ãƒ–ãƒ¬ã‚¤ã‚«ãƒ¼</title>
    
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&family=Orbitron:wght@700&display=swap" rel="stylesheet">

<style>
:root {
    --bg-color: #1a1a2e;
    --text-color: #fff;
    --primary: #00f2ff; /* Cyan */
    --accent: #ff0055;  /* Magenta */
    --gold: #ffd700;
}

body {
    margin: 0; background: var(--bg-color); color: var(--text-color);
    font-family: 'M PLUS Rounded 1c', sans-serif;
    height: 100vh; overflow: hidden; touch-action: none;
    display: flex; justify-content: center; align-items: center;
}

/* ç”»é¢å…±é€š */
.screen {
    position: absolute; width: 100%; height: 100%;
    display: none; flex-direction: column; align-items: center; justify-content: center;
    background: radial-gradient(circle at center, #2a2a40 0%, #000 100%);
    z-index: 1;
}
.screen.active { display: flex; z-index: 10; }

/* UIãƒ‘ãƒ¼ãƒ„ */
h1 { 
    font-family: 'Orbitron', sans-serif; font-size: 2.5rem; 
    text-shadow: 0 0 10px var(--primary); margin-bottom: 20px; text-align: center;
}
.btn {
    width: 80%; max-width: 300px; padding: 15px; margin: 10px;
    border: 2px solid var(--primary); border-radius: 8px; background: rgba(0,0,0,0.5);
    color: var(--primary); font-weight: bold; font-size: 1.1rem; cursor: pointer;
    text-transform: uppercase; transition: 0.2s;
}
.btn:active { background: var(--primary); color: #000; }
.btn-accent { border-color: var(--accent); color: var(--accent); }
.btn-accent:active { background: var(--accent); color: #000; }

.input-box {
    font-size: 1.2rem; padding: 10px; width: 70%; text-align: center;
    background: #000; border: 1px solid #555; color: #fff; margin: 10px 0;
}

/* ã‚²ãƒ¼ãƒ ç”»é¢ */
#game-container {
    position: relative; width: 100%; height: 100%; max-width: 600px;
    background: #000; box-shadow: 0 0 30px rgba(0,0,0,0.5);
}
canvas { display: block; width: 100%; height: 100%; }

/* HUD */
.hud {
    position: absolute; top: 10px; left: 0; width: 100%;
    display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box;
    pointer-events: none; font-family: 'Orbitron', sans-serif; z-index: 5;
    text-shadow: 0 0 5px #000;
}

/* ãƒ¢ãƒã‚¤ãƒ«æ“ä½œãƒ‘ãƒãƒ« */
.control-panel {
    position: absolute; bottom: 20px; width: 100%;
    display: flex; justify-content: center; gap: 20px;
    pointer-events: none; /* ä¸‹ã®ã‚­ãƒ£ãƒ³ãƒã‚¹æ“ä½œã‚’é€šã™ãŸã‚ */
}
.ctrl-btn {
    width: 70px; height: 70px; border-radius: 50%;
    background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.3);
    color: #fff; font-size: 1.5rem; font-weight: bold;
    display: flex; justify-content: center; align-items: center;
    pointer-events: auto; cursor: pointer; backdrop-filter: blur(5px);
    user-select: none; touch-action: none;
}
.ctrl-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.95); }
.btn-charge { border-color: var(--accent); color: var(--accent); width: 80px; height: 80px; }
.btn-charge.active { background: var(--accent); color: #fff; box-shadow: 0 0 20px var(--accent); }

/* QRãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ */
#qr-display { background: #fff; padding: 10px; margin: 15px; border-radius: 5px; }
#camera-wrapper { width: 90%; max-width: 300px; margin: 10px; border: 2px solid var(--primary); display: none; }

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal {
    position: absolute; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.9); z-index: 20;
    display: none; flex-direction: column; justify-content: center; align-items: center;
}
.blink { animation: blink 1s infinite alternate; }
@keyframes blink { from { opacity: 0.5; } to { opacity: 1; } }

</style>
</head>
<body>

<!-- ã‚¿ã‚¤ãƒˆãƒ« -->
<div id="screen-title" class="screen active">
    <h1>SMASH<br>BREAKER</h1>
    <div style="margin-bottom:30px; font-size:0.9rem; color:#aaa;">å›è»¢ï¼†ãƒãƒ£ãƒ¼ã‚¸ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
    <button class="btn" onclick="Game.startLocal()">ã²ã¨ã‚Šã§éŠã¶</button>
    <button class="btn btn-accent" onclick="Network.openMenu()">é€šä¿¡å¯¾æˆ¦ (QR/ID)</button>
    <div style="margin-top:20px; font-size:0.8rem;">æ“ä½œ: ã‚¹ãƒ©ã‚¤ãƒ‰ç§»å‹• / ãƒœã‚¿ãƒ³ã§å›è»¢ãƒ»ãƒãƒ£ãƒ¼ã‚¸</div>
</div>

<!-- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ -->
<div id="screen-network" class="screen">
    <h2>é€šä¿¡å¯¾æˆ¦</h2>
    <div id="net-select" style="display:flex; flex-direction:column; align-items:center; width:100%;">
        <button class="btn" onclick="Network.initHost()">éƒ¨å±‹ã‚’ã¤ãã‚‹ (ãƒ›ã‚¹ãƒˆ)</button>
        <div style="margin:5px;">or</div>
        <button class="btn btn-accent" onclick="Network.showGuest()">éƒ¨å±‹ã«å…¥ã‚‹ (ã‚²ã‚¹ãƒˆ)</button>
        <button class="btn" style="border-color:#555; color:#aaa;" onclick="location.reload()">ã‚‚ã©ã‚‹</button>
    </div>
    
    <div id="net-host" style="display:none; flex-direction:column; align-items:center;">
        <div id="qr-display"></div>
        <div>ID: <span id="host-id-text" style="color:var(--primary); font-weight:bold;">---</span></div>
        <div class="blink" style="color:var(--accent); margin:10px;">æ¥ç¶šå¾…ã¡...</div>
        <button class="btn" onclick="location.reload()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>

    <div id="net-guest" style="display:none; flex-direction:column; align-items:center; width:100%;">
        <div id="camera-wrapper"></div>
        <button class="btn" onclick="Network.startCamera()">ğŸ“· QRã‚’èª­ã¿å–ã‚‹</button>
        <input type="text" id="input-id" class="input-box" placeholder="IDã‚’å…¥åŠ›">
        <button class="btn btn-accent" onclick="Network.joinByInput()">IDã§å‚åŠ </button>
        <button class="btn" onclick="location.reload()">ã‚‚ã©ã‚‹</button>
    </div>
</div>

<!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
<div id="screen-game" class="screen" style="background:#000;">
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        
        <div class="hud">
            <div id="hud-left">STAGE 1</div>
            <div id="hud-right">SCORE: 0</div>
        </div>

        <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨æ“ä½œãƒ‘ãƒãƒ« -->
        <div class="control-panel">
            <div class="ctrl-btn" onpointerdown="Input.setRotate(-1)" onpointerup="Input.setRotate(0)" onpointerleave="Input.setRotate(0)">â†º</div>
            <div id="btn-charge" class="ctrl-btn btn-charge" onpointerdown="Input.setCharge(true)" onpointerup="Input.setCharge(false)" onpointerleave="Input.setCharge(false)">âš¡</div>
            <div class="ctrl-btn" onpointerdown="Input.setRotate(1)" onpointerup="Input.setRotate(0)" onpointerleave="Input.setRotate(0)">â†»</div>
        </div>

        <!-- çµæœ -->
        <div id="result-modal" class="modal">
            <h2 id="res-title">GAME OVER</h2>
            <div id="res-score" style="font-size:1.5rem; margin-bottom:20px; font-family:'Orbitron';">SCORE: 0</div>
            <button class="btn btn-accent" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
        </div>
        
        <!-- å¾…æ©Ÿ -->
        <div id="wait-overlay" class="modal" style="background:rgba(0,0,0,0.6);">
            <h2>WAITING...</h2>
        </div>
    </div>
</div>

<script>
/**
 * SMASH BREAKER - REBORN
 * å›è»¢ãƒ»ãƒãƒ£ãƒ¼ã‚¸æ©Ÿèƒ½å¾©æ´»ç‰ˆ
 */

// éŸ³å£°
const AudioSys = {
    ctx: null,
    init() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); },
    play(type) {
        if(!this.ctx) return;
        const t = this.ctx.currentTime;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.connect(g); g.connect(this.ctx.destination);
        
        if(type==='hit') { o.type='square'; o.frequency.setValueAtTime(400, t); g.gain.exponentialRampToValueAtTime(0.01, t+0.1); }
        else if(type==='charge') { o.type='sawtooth'; o.frequency.setValueAtTime(100, t); g.gain.linearRampToValueAtTime(0, t+0.2); }
        else if(type==='smash') { o.type='square'; o.frequency.setValueAtTime(150, t); o.frequency.linearRampToValueAtTime(600, t+0.1); g.gain.exponentialRampToValueAtTime(0.01, t+0.2); }
        else if(type==='win') { o.type='triangle'; o.frequency.setValueAtTime(523, t); g.gain.linearRampToValueAtTime(0, t+0.5); }
        
        o.start(); o.stop(t+0.5);
    }
};

// å…¥åŠ›ç®¡ç†
const Input = {
    x: null, // ãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒXåº§æ¨™
    rotate: 0, // -1(å·¦), 0, 1(å³)
    charge: false,
    
    init() {
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰
        window.addEventListener('keydown', e => {
            if(e.code==='ArrowLeft'||e.code==='KeyA') this.x = 'left'; // ç°¡æ˜“ç§»å‹•ç”¨ãƒ•ãƒ©ã‚°(å®Ÿéš›ã®ç§»å‹•ã¯touchXå„ªå…ˆã ãŒã‚­ãƒ¼ã‚‚å¯¾å¿œ)
            if(e.code==='ArrowRight'||e.code==='KeyD') this.x = 'right';
            if(e.code==='ArrowUp'||e.code==='KeyW') this.rotate = 1; // å³å›è»¢
            if(e.code==='ArrowDown'||e.code==='KeyS') this.rotate = -1; // å·¦å›è»¢
            if(e.code==='Space'||e.code==='ShiftLeft') this.charge = true;
        });
        window.addEventListener('keyup', e => {
            if(e.code==='ArrowUp'||e.code==='ArrowDown'||e.code==='KeyW'||e.code==='KeyS') this.rotate = 0;
            if(e.code==='Space'||e.code==='ShiftLeft') this.charge = false;
            if(e.code==='ArrowLeft'||e.code==='ArrowRight'||e.code==='KeyA'||e.code==='KeyD') this.x = null;
        });
        
        // ã‚¿ãƒƒãƒç§»å‹• (ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Š)
        const cvs = document.getElementById('game-canvas');
        const moveHandler = (e) => {
            e.preventDefault();
            const rect = cvs.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            // ç”»é¢å¹…ã«å¯¾ã™ã‚‹æ¯”ç‡ã§ä½ç½®è¨ˆç®— (è§£åƒåº¦å¯¾å¿œ)
            const scale = Game.width / rect.width;
            this.x = (clientX - rect.left) * scale;
        };
        cvs.addEventListener('mousemove', moveHandler);
        cvs.addEventListener('touchmove', moveHandler, {passive:false});
        cvs.addEventListener('touchstart', moveHandler, {passive:false});
    },
    
    setRotate(val) { this.rotate = val; },
    setCharge(val) { this.charge = val; }
};

// ãƒ‘ãƒ‰ãƒ«ã‚¯ãƒ©ã‚¹
class Paddle {
    constructor(x, y, isEnemy=false) {
        this.x = x; this.y = y; 
        this.w = 100; this.h = 15;
        this.angle = 0;
        this.chargeVal = 0;
        this.isEnemy = isEnemy;
    }
    
    update(input) {
        // ç§»å‹•
        if (typeof input.x === 'number') {
            this.x += (input.x - this.x) * 0.3; // ã‚¹ãƒ ãƒ¼ã‚ºè¿½å¾“
        } else if (input.x === 'left') {
            this.x -= 8;
        } else if (input.x === 'right') {
            this.x += 8;
        }
        
        // ç”»é¢ç«¯åˆ¶é™
        this.x = Math.max(this.w/2, Math.min(Game.width - this.w/2, this.x));
        
        // å›è»¢
        if (input.rotate !== 0) {
            this.angle += input.rotate * 0.05;
            this.angle = Math.max(-0.5, Math.min(0.5, this.angle)); // è§’åº¦åˆ¶é™
        } else {
            // æ“ä½œã—ã¦ãªã„ã¨ãã¯å¾ã€…ã«æˆ»ã‚‹
            this.angle *= 0.9;
        }
        
        // ãƒãƒ£ãƒ¼ã‚¸
        if (input.charge) {
            this.chargeVal = Math.min(100, this.chargeVal + 2);
            if(this.chargeVal % 20 === 0) AudioSys.play('charge');
        } else {
            if (this.chargeVal > 0) this.chargeVal -= 5;
            if (this.chargeVal < 0) this.chargeVal = 0;
        }
        
        // UIé€£å‹• (è‡ªåˆ†ã®ã¿)
        if(!this.isEnemy) {
            const btn = document.getElementById('btn-charge');
            if(input.charge) btn.classList.add('active');
            else btn.classList.remove('active');
        }
    }
    
    draw(ctx) {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        
        // ãƒãƒ£ãƒ¼ã‚¸ç™ºå…‰
        if (this.chargeVal > 0) {
            ctx.shadowBlur = this.chargeVal;
            ctx.shadowColor = this.isEnemy ? '#ff0055' : '#00f2ff';
        }
        
        ctx.fillStyle = this.isEnemy ? '#ff0055' : '#00f2ff';
        ctx.fillRect(-this.w/2, -this.h/2, this.w, this.h);
        
        // èŠ¯
        ctx.fillStyle = '#fff';
        ctx.fillRect(-this.w/2 + 2, -this.h/2 + 2, this.w - 4, this.h - 4);
        
        ctx.restore();
    }
}

// ã‚²ãƒ¼ãƒ æœ¬ä½“
const Game = {
    canvas: null, ctx: null, loopId: null,
    width: 600, height: 800,
    
    mode: 'local', // local, online
    role: 'p1',    // p1(host), p2(guest)
    state: 'title',
    
    p1: null, p2: null, ball: null, blocks: [],
    score: 0, stage: 1,
    
    startLocal() {
        this.mode = 'local'; this.role = 'p1';
        this.init();
    },
    startOnline(isHost) {
        this.mode = 'online';
        this.role = isHost ? 'p1' : 'p2';
        this.init();
    },
    
    init() {
        AudioSys.init();
        Input.init();
        
        document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
        document.getElementById('screen-game').classList.add('active');
        document.getElementById('result-modal').style.display='none';
        document.getElementById('wait-overlay').style.display='none';
        
        this.canvas = document.getElementById('game-canvas');
        this.ctx = this.canvas.getContext('2d');
        // è§£åƒåº¦åˆã‚ã›
        const rect = document.getElementById('game-container').getBoundingClientRect();
        this.canvas.width = this.width = 600; 
        this.canvas.height = this.height = 800; // å†…éƒ¨è§£åƒåº¦ã¯å›ºå®š
        
        this.p1 = new Paddle(300, 750);
        this.p2 = new Paddle(300, 50, true);
        this.ball = { x:300, y:400, r:8, vx:0, vy:0, speed:8, power:false };
        
        this.setupStage(1);
        this.resetBall();
        
        this.state = 'playing';
        if(this.loopId) cancelAnimationFrame(this.loopId);
        this.loop();
    },
    
    setupStage(lvl) {
        this.stage = lvl; this.score = 0; this.blocks = [];
        if(this.mode === 'online') return; // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã¯ãƒ–ãƒ­ãƒƒã‚¯ãªã—ï¼ˆå¯¾æˆ¦ç‰¹åŒ–ï¼‰
        
        const rows = 3 + lvl;
        for(let r=0; r<rows; r++) {
            for(let c=0; c<8; c++) {
                if(Math.random()>0.2) {
                    this.blocks.push({
                        x: 40 + c * 70, y: 100 + r * 30, w: 60, h: 20,
                        color: `hsl(${r*40}, 70%, 50%)`, hp: 1
                    });
                }
            }
        }
    },
    
    resetBall() {
        this.ball.x = 300; this.ball.y = 400; this.ball.power = false;
        const a = Math.PI/2 + (Math.random()-0.5);
        this.ball.vx = Math.cos(a) * this.ball.speed;
        this.ball.vy = Math.sin(a) * this.ball.speed * (this.mode==='local'?-1: (this.role==='p1'?1:-1)); 
        // ãƒ­ãƒ¼ã‚«ãƒ«ã¯ä¸Šã¸ã€ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã¯å½¹å‰²ã«å¿œã˜ã¦ï¼ˆHostãªã‚‰ä¸‹ã¸ã€Guestãªã‚‰ä¸Šã¸...èª¿æ•´å¿…è¦ï¼‰
        if(this.mode==='online' && this.role==='p2') { this.ball.vx=0; this.ball.vy=0; } // Guestã¯è¨ˆç®—ã—ãªã„
    },
    
    loop() {
        if(this.state !== 'playing') return;
        this.update();
        this.draw();
        if(this.mode==='online') this.sync();
        this.loopId = requestAnimationFrame(()=>this.loop());
    },
    
    update() {
        // è‡ªæ©Ÿæ›´æ–°
        this.p1.update(Input);
        
        // ç‰©ç†æ¼”ç®— (Local or Host)
        if(this.mode==='local' || (this.mode==='online' && this.role==='p1')) {
            // æ•µAI (ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿)
            if(this.mode==='local') {
                // ç°¡æ˜“AI
                this.p2.x += (this.ball.x - this.p2.x) * 0.1;
                this.p2.angle = 0; // AIã¯å›è»¢ã—ãªã„
            }
            
            // ãƒœãƒ¼ãƒ«ç§»å‹•
            const b = this.ball;
            const speed = b.power ? 15 : b.speed;
            b.x += b.vx; b.y += b.vy;
            
            // å£
            if(b.x < b.r || b.x > this.width - b.r) b.vx *= -1;
            
            // ãƒ‘ãƒ‰ãƒ«è¡çª (å›è»¢è€ƒæ…®)
            this.checkPaddle(b, this.p1);
            this.checkPaddle(b, this.p2);
            
            // ãƒ­ãƒ¼ã‚«ãƒ«å¤©äº•åå°„
            if(this.mode==='local' && b.y < b.r) b.vy *= -1;
            
            // ãƒ–ãƒ­ãƒƒã‚¯
            for(let i=this.blocks.length-1; i>=0; i--) {
                const blk = this.blocks[i];
                if(b.x > blk.x && b.x < blk.x+blk.w && b.y > blk.y && b.y < blk.y+blk.h) {
                    if(!b.power) b.vy *= -1; // ãƒ‘ãƒ¯ãƒ¼ãƒœãƒ¼ãƒ«ã¯è²«é€š
                    this.blocks.splice(i,1);
                    this.score += 100;
                    AudioSys.play('hit');
                }
            }
            
            // è½ä¸‹åˆ¤å®š
            if(b.y > this.height + 20) {
                if(this.mode==='local') this.gameOver("GAME OVER");
                else {
                    this.gameOver("LOSE...");
                    Network.send({ type:'over', win:true });
                }
            }
            if(this.mode==='online' && b.y < -20) {
                this.gameOver("WIN!");
                Network.send({ type:'over', win:false });
            }
            
            // ã‚¯ãƒªã‚¢åˆ¤å®š
            if(this.mode==='local' && this.blocks.length===0) {
                this.setupStage(this.stage+1);
                this.resetBall();
            }
        }
    },
    
    // å›è»¢ãƒ‘ãƒ‰ãƒ«ã¨ã®è¡çªåˆ¤å®š (ç°¡æ˜“ç‰ˆ: è§’åº¦ã‚’åŠ ç®—)
    checkPaddle(b, p) {
        // AABBãƒã‚§ãƒƒã‚¯
        if(b.x > p.x - p.w/2 - b.r && b.x < p.x + p.w/2 + b.r &&
           b.y > p.y - p.h/2 - b.r && b.y < p.y + p.h/2 + b.r) {
            
            // ç°¡æ˜“çš„ã«Yé€Ÿåº¦åè»¢ + è§’åº¦ã«ã‚ˆã‚‹Xé€Ÿåº¦å¤‰åŒ–
            b.vy *= -1;
            
            // ãƒ‘ãƒ‰ãƒ«ã®è§’åº¦ã«å¿œã˜ã¦Xé€Ÿåº¦ã‚’å¤‰åŒ–ï¼ˆã‚¹ãƒ”ãƒ³ï¼‰
            b.vx += p.angle * 10;
            
            // ä½ç½®è£œæ­£
            b.y += b.vy * 2; 
            
            // ãƒãƒ£ãƒ¼ã‚¸è§£æ”¾åˆ¤å®š
            if(p.chargeVal > 80) {
                b.power = true;
                AudioSys.play('smash');
                p.chargeVal = 0; // æ¶ˆè²»
            } else {
                b.power = false;
                AudioSys.play('hit');
            }
        }
    },
    
    draw() {
        const ctx = this.ctx;
        ctx.clearRect(0,0,this.width,this.height);
        
        // ãƒ–ãƒ­ãƒƒã‚¯
        this.blocks.forEach(b => {
            ctx.fillStyle = b.color;
            ctx.fillRect(b.x, b.y, b.w, b.h);
        });
        
        // ãƒ‘ãƒ‰ãƒ«
        this.p1.draw(ctx);
        this.p2.draw(ctx);
        
        // ãƒœãƒ¼ãƒ«
        ctx.beginPath();
        ctx.arc(this.ball.x, this.ball.y, this.ball.r, 0, Math.PI*2);
        ctx.fillStyle = this.ball.power ? '#ffff00' : '#fff';
        if(this.ball.power) {
            ctx.shadowBlur = 20; ctx.shadowColor = '#ffff00';
        } else {
            ctx.shadowBlur = 0;
        }
        ctx.fill(); ctx.shadowBlur = 0;
        
        // UI
        document.getElementById('hud-right').innerText = "SCORE: " + this.score;
    },
    
    // --- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åŒæœŸ ---
    sync() {
        if(this.role === 'p1') {
            // ãƒ›ã‚¹ãƒˆ: å…¨ãƒ‡ãƒ¼ã‚¿é€ä¿¡
            Network.send({
                type: 'sync',
                p1: { x:this.p1.x, a:this.p1.angle, c:this.p1.chargeVal },
                b: { x:this.ball.x, y:this.ball.y, p:this.ball.power }
            });
        } else {
            // ã‚²ã‚¹ãƒˆ: è‡ªåˆ†ã®å…¥åŠ›é€ä¿¡
            Network.send({
                type: 'input',
                x: this.p1.x, a: this.p1.angle, c: this.p1.chargeVal
            });
        }
    },
    
    onNetworkData(d) {
        if(d.type === 'sync') {
            // ã‚²ã‚¹ãƒˆå´: ç›¸æ‰‹(P1=Host)ã¯ç”»é¢ä¸Š(P2)ã«è¡¨ç¤º
            this.p2.x = d.p1.x; this.p2.angle = d.p1.a; this.p2.chargeVal = d.p1.c;
            this.ball.x = d.b.x; this.ball.y = d.b.y; this.ball.power = d.b.p;
        } else if(d.type === 'input') {
            // ãƒ›ã‚¹ãƒˆå´: ç›¸æ‰‹(P2=Guest)ã®å…¥åŠ›åæ˜ 
            this.p2.x = d.x; this.p2.angle = d.a; this.p2.chargeVal = d.c;
        } else if(d.type === 'over') {
            this.gameOver(d.win ? "WIN!" : "LOSE...");
        }
    },
    
    gameOver(msg) {
        this.state = 'over';
        document.getElementById('result-modal').style.display = 'flex';
        document.getElementById('res-title').innerText = msg;
        document.getElementById('res-score').innerText = "SCORE: " + this.score;
        AudioSys.play('win');
    }
};

// ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¯ãƒ©ã‚¹
const Network = {
    peer: null, conn: null, scanner: null,
    
    openMenu() {
        document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
        document.getElementById('screen-network').classList.add('active');
        document.getElementById('net-select').style.display='flex';
        document.getElementById('net-host').style.display='none';
        document.getElementById('net-guest').style.display='none';
    },
    
    initHost() {
        document.getElementById('net-select').style.display='none';
        document.getElementById('net-host').style.display='flex';
        this.peer = new Peer();
        this.peer.on('open', id => {
            document.getElementById('host-id-text').innerText = id;
            document.getElementById('qr-display').innerHTML = "";
            new QRCode(document.getElementById("qr-display"), { text:id, width:150, height:150 });
        });
        this.peer.on('connection', c => {
            this.conn = c; this.setup();
            Game.startOnline(true);
        });
    },
    
    showGuest() {
        document.getElementById('net-select').style.display='none';
        document.getElementById('net-guest').style.display='flex';
    },
    
    startCamera() {
        const w = document.getElementById('camera-wrapper');
        w.style.display='block';
        this.scanner = new Html5QrcodeScanner("camera-wrapper", { fps: 10, qrbox: 200 });
        this.scanner.render(id => {
            this.join(id);
            this.scanner.clear();
            w.style.display='none';
        });
    },
    
    joinByInput() {
        const id = document.getElementById('input-id').value;
        if(id) this.join(id);
    },
    
    join(id) {
        this.peer = new Peer();
        this.peer.on('open', () => {
            this.conn = this.peer.connect(id);
            this.setup();
            Game.startOnline(false);
        });
    },
    
    setup() {
        this.conn.on('data', d => Game.onNetworkData(d));
        this.conn.on('close', () => alert("é€šä¿¡åˆ‡æ–­"));
    },
    
    send(d) { if(this.conn) this.conn.send(d); }
};

</script>
</body>
</html>
